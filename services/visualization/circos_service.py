"""
pyCirclize Visualization Service
Generates circular genomics visualizations for MINDEX data
"""

import io
import base64
from typing import Optional, List, Dict, Any
from dataclasses import dataclass
from enum import Enum

# Note: These imports require pycirclize and matplotlib
# Install with: pip install pycirclize matplotlib biopython


class PlotType(str, Enum):
    GENOME = "genome"
    PHYLOGENY = "phylogeny"
    PATHWAY = "pathway"
    CHORD = "chord"
    RADAR = "radar"


@dataclass
class CircosTrack:
    """Data for a single track in the circos plot"""
    name: str
    data: List[Dict[str, Any]]
    color: str = "#22c55e"
    track_type: str = "bar"  # bar, line, scatter, heatmap, link


@dataclass
class CircosConfig:
    """Configuration for circos plot generation"""
    plot_type: PlotType = PlotType.GENOME
    title: str = "MINDEX Circos Plot"
    sectors: List[str] = None
    tracks: List[CircosTrack] = None
    width: int = 800
    height: int = 800
    start_angle: int = 90
    end_angle: int = 360


def generate_genome_circos(
    species_name: str = "Psilocybe cubensis",
    chromosomes: Optional[List[Dict]] = None,
    genes: Optional[List[Dict]] = None,
    variants: Optional[List[Dict]] = None,
    output_format: str = "svg"
) -> str:
    """
    Generate a genome circos plot for a fungal species.
    
    Returns base64-encoded SVG or PNG.
    """
    try:
        from pycirclize import Circos
        import matplotlib.pyplot as plt
        
        # Default demo data if none provided
        if chromosomes is None:
            chromosomes = [
                {"name": "chr1", "length": 5000000, "color": "#8B5CF6"},
                {"name": "chr2", "length": 4200000, "color": "#06B6D4"},
                {"name": "chr3", "length": 3800000, "color": "#22C55E"},
                {"name": "chr4", "length": 3200000, "color": "#F59E0B"},
                {"name": "chr5", "length": 2800000, "color": "#EC4899"},
            ]
        
        # Create sectors from chromosome data
        sectors = {chr["name"]: chr["length"] for chr in chromosomes}
        
        # Initialize Circos
        circos = Circos(sectors, space=5)
        
        # Add chromosome tracks
        for sector in circos.sectors:
            # Outer track - chromosome ideogram
            track1 = sector.add_track((90, 100))
            track1.axis(fc=next((c["color"] for c in chromosomes if c["name"] == sector.name), "#666"))
            track1.text(sector.name, color="white", size=10)
            
            # Gene density track
            track2 = sector.add_track((75, 88))
            track2.axis(fc="#1e1e2e", ec="gray", alpha=0.5)
            
            # Generate demo gene density data
            import numpy as np
            x = np.linspace(0, sector.size, 100)
            y = np.abs(np.sin(x / 500000) * 50 + np.random.randn(100) * 10 + 30)
            track2.fill_between(x, y, fc="#22c55e", alpha=0.7)
            
            # Variant track
            track3 = sector.add_track((60, 73))
            track3.axis(fc="#1e1e2e", ec="gray", alpha=0.5)
            
            # Demo variant data
            var_x = np.random.uniform(0, sector.size, 20)
            var_y = np.random.uniform(5, 12, 20)
            track3.scatter(var_x, var_y, c="#f59e0b", s=15, alpha=0.8)
            
            # Expression track
            track4 = sector.add_track((45, 58))
            track4.axis(fc="#1e1e2e", ec="gray", alpha=0.5)
            
            expr_x = np.linspace(0, sector.size, 50)
            expr_y = np.abs(np.cos(expr_x / 300000) * 6 + np.random.randn(50) * 2 + 6)
            track4.line(expr_x, expr_y, color="#8b5cf6", lw=1.5)
        
        # Add links between chromosomes (demo synteny)
        if len(sectors) >= 2:
            sector_names = list(sectors.keys())
            for i in range(min(3, len(sector_names) - 1)):
                start = (sector_names[i], 1000000, 1500000)
                end = (sector_names[i + 1], 500000, 1000000)
                circos.link(start, end, color="#06b6d4", alpha=0.3)
        
        # Generate figure
        fig = circos.plotfig()
        
        # Add title
        fig.text(0.5, 0.98, f"{species_name} Genome", ha="center", va="top", 
                 fontsize=14, fontweight="bold", color="white")
        fig.text(0.5, 0.95, "Generated by MINDEX pyCirclize", ha="center", va="top",
                 fontsize=8, color="gray")
        
        # Set background
        fig.patch.set_facecolor("#0a0a0f")
        
        # Save to buffer
        buffer = io.BytesIO()
        if output_format == "png":
            fig.savefig(buffer, format="png", dpi=150, facecolor="#0a0a0f", 
                       edgecolor="none", bbox_inches="tight")
            mime_type = "image/png"
        else:
            fig.savefig(buffer, format="svg", facecolor="#0a0a0f", 
                       edgecolor="none", bbox_inches="tight")
            mime_type = "image/svg+xml"
        
        plt.close(fig)
        buffer.seek(0)
        
        # Encode as base64
        encoded = base64.b64encode(buffer.getvalue()).decode("utf-8")
        return f"data:{mime_type};base64,{encoded}"
        
    except ImportError as e:
        return generate_fallback_svg(species_name, str(e))


def generate_pathway_circos(
    pathway_name: str = "Psilocybin Biosynthesis",
    genes: Optional[List[Dict]] = None,
    metabolites: Optional[List[Dict]] = None,
    output_format: str = "svg"
) -> str:
    """
    Generate a pathway circos plot for metabolic pathways.
    """
    try:
        from pycirclize import Circos
        import matplotlib.pyplot as plt
        import numpy as np
        
        # Default pathway data
        if genes is None:
            genes = [
                {"name": "psiD", "position": 0, "expression": 0.9},
                {"name": "psiK", "position": 1, "expression": 0.7},
                {"name": "psiM", "position": 2, "expression": 0.8},
                {"name": "psiH", "position": 3, "expression": 0.6},
                {"name": "psiR", "position": 4, "expression": 0.5},
            ]
        
        if metabolites is None:
            metabolites = [
                {"name": "Tryptophan", "position": 0},
                {"name": "Tryptamine", "position": 1},
                {"name": "4-HT", "position": 2},
                {"name": "Norbaeocystin", "position": 3},
                {"name": "Baeocystin", "position": 4},
                {"name": "Psilocybin", "position": 5},
            ]
        
        # Create chord diagram for pathway
        matrix_size = len(genes)
        matrix = np.zeros((matrix_size, matrix_size))
        
        # Create flow between sequential genes
        for i in range(matrix_size - 1):
            matrix[i][i + 1] = genes[i]["expression"] * 100
        
        # Create Circos chord diagram
        sector_names = [g["name"] for g in genes]
        circos = Circos.initialize_from_matrix(
            matrix,
            sector_names=sector_names,
            start=-90,
            end=270,
            space=3,
            r_lim=(50, 100),
            cmap="YlGn",
        )
        
        fig = circos.plotfig()
        fig.text(0.5, 0.98, pathway_name, ha="center", va="top",
                 fontsize=14, fontweight="bold", color="white")
        fig.patch.set_facecolor("#0a0a0f")
        
        buffer = io.BytesIO()
        if output_format == "png":
            fig.savefig(buffer, format="png", dpi=150, facecolor="#0a0a0f",
                       edgecolor="none", bbox_inches="tight")
            mime_type = "image/png"
        else:
            fig.savefig(buffer, format="svg", facecolor="#0a0a0f",
                       edgecolor="none", bbox_inches="tight")
            mime_type = "image/svg+xml"
        
        plt.close(fig)
        buffer.seek(0)
        
        encoded = base64.b64encode(buffer.getvalue()).decode("utf-8")
        return f"data:{mime_type};base64,{encoded}"
        
    except ImportError as e:
        return generate_fallback_svg(pathway_name, str(e))


def generate_phylogeny_circos(
    species_list: Optional[List[str]] = None,
    output_format: str = "svg"
) -> str:
    """
    Generate a circular phylogenetic tree visualization.
    """
    try:
        from pycirclize import Circos
        from pycirclize.parser import Gff
        import matplotlib.pyplot as plt
        import numpy as np
        
        if species_list is None:
            species_list = [
                "P. cubensis",
                "P. semilanceata",
                "P. cyanescens",
                "P. azurescens",
                "H. erinaceus",
                "G. lucidum",
                "C. militaris",
                "A. bisporus",
            ]
        
        # Create a simple circular layout for species
        n_species = len(species_list)
        sectors = {sp: 100 for sp in species_list}
        
        circos = Circos(sectors, space=8)
        
        colors = ["#8B5CF6", "#06B6D4", "#22C55E", "#F59E0B", 
                  "#EC4899", "#3B82F6", "#EF4444", "#84CC16"]
        
        for i, sector in enumerate(circos.sectors):
            color = colors[i % len(colors)]
            track = sector.add_track((80, 100))
            track.axis(fc=color, alpha=0.8)
            track.text(sector.name, size=9, color="white", r=110)
        
        # Add some demo phylogenetic links
        sector_names = list(sectors.keys())
        for i in range(0, n_species - 1, 2):
            if i + 1 < n_species:
                start = (sector_names[i], 20, 80)
                end = (sector_names[i + 1], 20, 80)
                circos.link(start, end, color=colors[i % len(colors)], alpha=0.3)
        
        fig = circos.plotfig()
        fig.text(0.5, 0.5, "Fungal\nPhylogeny", ha="center", va="center",
                 fontsize=12, fontweight="bold", color="white")
        fig.patch.set_facecolor("#0a0a0f")
        
        buffer = io.BytesIO()
        if output_format == "png":
            fig.savefig(buffer, format="png", dpi=150, facecolor="#0a0a0f",
                       edgecolor="none", bbox_inches="tight")
            mime_type = "image/png"
        else:
            fig.savefig(buffer, format="svg", facecolor="#0a0a0f",
                       edgecolor="none", bbox_inches="tight")
            mime_type = "image/svg+xml"
        
        plt.close(fig)
        buffer.seek(0)
        
        encoded = base64.b64encode(buffer.getvalue()).decode("utf-8")
        return f"data:{mime_type};base64,{encoded}"
        
    except ImportError as e:
        return generate_fallback_svg("Phylogeny", str(e))


def generate_fallback_svg(title: str, error: str = "") -> str:
    """Generate a fallback SVG when pyCirclize is not available."""
    svg = f'''
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400">
        <rect width="400" height="400" fill="#0a0a0f"/>
        <circle cx="200" cy="200" r="150" fill="none" stroke="#22c55e" stroke-width="2" opacity="0.3"/>
        <circle cx="200" cy="200" r="120" fill="none" stroke="#8b5cf6" stroke-width="2" opacity="0.3"/>
        <circle cx="200" cy="200" r="90" fill="none" stroke="#06b6d4" stroke-width="2" opacity="0.3"/>
        <text x="200" y="190" text-anchor="middle" fill="white" font-size="14" font-weight="bold">{title}</text>
        <text x="200" y="210" text-anchor="middle" fill="#888" font-size="10">Circos Visualization</text>
        <text x="200" y="230" text-anchor="middle" fill="#666" font-size="8">Install pycirclize for full features</text>
    </svg>
    '''
    encoded = base64.b64encode(svg.encode()).decode("utf-8")
    return f"data:image/svg+xml;base64,{encoded}"


# FastAPI endpoint handler
async def handle_circos_request(
    plot_type: str = "genome",
    species: str = "Psilocybe cubensis",
    output_format: str = "svg",
    **kwargs
) -> Dict[str, Any]:
    """
    Handle API request for circos visualization.
    """
    try:
        if plot_type == "genome":
            image_data = generate_genome_circos(
                species_name=species,
                output_format=output_format
            )
        elif plot_type == "pathway":
            pathway_name = kwargs.get("pathway", "Psilocybin Biosynthesis")
            image_data = generate_pathway_circos(
                pathway_name=pathway_name,
                output_format=output_format
            )
        elif plot_type == "phylogeny":
            species_list = kwargs.get("species_list")
            image_data = generate_phylogeny_circos(
                species_list=species_list,
                output_format=output_format
            )
        else:
            return {"error": f"Unknown plot type: {plot_type}"}
        
        return {
            "success": True,
            "plot_type": plot_type,
            "species": species,
            "format": output_format,
            "image": image_data
        }
        
    except Exception as e:
        return {
            "success": False,
            "error": str(e),
            "image": generate_fallback_svg(species, str(e))
        }


if __name__ == "__main__":
    # Test generation
    print("Testing pyCirclize integration...")
    result = generate_genome_circos()
    print(f"Generated image: {result[:100]}...")
