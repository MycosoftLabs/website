# n8n Workflow Templates for NatureOS

**Date**: 2026-01-16  
**Version**: 1.0.0

---

## Overview

This directory contains n8n workflow templates for integrating external systems with NatureOS OEI (Environmental Common Operating Picture).

---

## Available Workflows

### 1. Device Ingestion Workflow
**File**: `device-ingestion-workflow.json`

General-purpose device telemetry ingestion:
- Webhook endpoint for HTTP POST from devices
- Normalizes telemetry data to NatureOS format
- Sends to `/api/devices/ingest`
- Optional alert generation for threshold breaches

**Usage**:
1. Import into n8n
2. Activate workflow
3. Configure devices to POST telemetry to webhook URL
4. Optional: Set `WEBSITE_URL` environment variable

### 2. ChirpStack LoRaWAN Integration
**File**: `lorawan-chirpstack-workflow.json`

Integrates ChirpStack LoRaWAN server with NatureOS:
- Receives uplink messages from ChirpStack
- Parses LoRaWAN payload (supports codec-decoded objects)
- Forwards to NatureOS device ingestion
- Auto-registers new devices

**Setup**:
1. Import workflow into n8n
2. Get webhook URL from n8n
3. In ChirpStack: Application → Integrations → HTTP → Add URL
4. Set Content-Type to `application/json`

---

## Environment Variables

Set these in your n8n instance:

| Variable | Default | Description |
|----------|---------|-------------|
| `WEBSITE_URL` | `http://localhost:3000` | NatureOS website base URL |
| `OEI_API_KEY` | (none) | Optional API key for authenticated requests |

---

## Importing Workflows

### Via n8n UI:
1. Open n8n → Workflows → Import from File
2. Select the `.json` file
3. Save and activate

### Via n8n CLI:
```bash
n8n import:workflow --input=device-ingestion-workflow.json
```

---

## Creating Custom Workflows

### Device Telemetry Format

NatureOS expects telemetry in this format:

```json
{
  "deviceId": "mycobrain-001",
  "deviceType": "mycobrain",
  "timestamp": "2026-01-16T12:00:00.000Z",
  "readings": {
    "temp": 22.5,
    "humidity": 65,
    "pressure": 1013.25,
    "co2": 450,
    "voc": 0.12,
    "iaq": 75
  },
  "location": {
    "latitude": 37.7749,
    "longitude": -122.4194
  },
  "metadata": {
    "firmware": "1.2.3",
    "battery": 3.7
  }
}
```

### API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/devices/ingest` | POST | Ingest telemetry data |
| `/api/devices/register` | POST | Register new device |
| `/api/devices/register` | DELETE | Unregister device |
| `/api/oei/events` | POST | Create OEI event |
| `/api/oei/entities` | GET | List entities |
| `/api/oei/observations` | GET | List observations |

---

## Troubleshooting

### Workflow not triggering
- Check webhook is activated (green toggle)
- Verify URL is correct in ChirpStack/device config
- Check n8n logs for incoming requests

### Data not appearing in NatureOS
- Verify WEBSITE_URL is accessible from n8n container
- Check NatureOS container logs for errors
- Verify device ID format matches expected pattern

### Authentication errors
- Set OEI_API_KEY if API requires authentication
- Check CORS settings if browser is involved

---

## Additional Workflows (Coming Soon)

- **Home Assistant Integration**: Sync HA entities with NatureOS
- **Weather Alert Processor**: Fetch and process NWS alerts
- **Biodiversity Scheduler**: Periodic GBIF/eBird data fetch
- **Space Weather Monitor**: NOAA SWPC data integration

---

*Document generated by MYCA Integration System - 2026-01-16*
